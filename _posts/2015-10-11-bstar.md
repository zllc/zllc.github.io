---
layout: post
title: 双星反应器
tags: FSM 高可用
categories: zmq
---

双星模式是zmq提出的一个基于有限状态机的高可用方案，模型简洁、高效，其中有很多值得借鉴的地方。

# 双星模式的原始形式

我们先来看代码

- **服务端代码分析**
	
	[bstarsrv.c][bstarsrv.c]
	
	服务端核心是一个`事件`驱动的 [有限状态机（FSM）][fsm]。我们看到首先定义了一个描述状态的结构体，包含四种枚举状态：主server（主节点）、备份server（备节点）、主动状态（可以响应客户端请求）、被动状态（不处理客户端请求）。定义了一个事件结构体，包含5种事件。枚举值的设置很巧妙，server发送的事件刚好等于自己的状态，后面我们将细细体会这种设计的妙处。
	
	* 状态模型
	
	![state-machine](/static/img/zmq/st.001.jpg)
	
	上面的是server核心状态机模型。st-primary与st-backup是server的初始状态，系统运行时可以简化为只有st-active与st-passive两种状态，黄色连线表示这两种状态之间的事件与状态转换，可以看到，这个状态机保证了不会出现`脑裂`。
	
	* 通信模型
	
	![state-machine](/static/img/zmq/st.002.jpg)
	
	上图是双星模式的通信模型。client与两个server形成了一个三方决策模型，client起到了投票的作用。
	
	研究代码我们发现，每个server发送的都是自己的状态，接收方就会把对方的状态作为接收到的事件，这个里面有一个隐含的映射，即状态与事件之间的映射，而两个结构体的设计已经巧妙的包含了这一层映射。
	
	两个server之间心跳是用的pub/sub套接字。心跳发送间隔为常量1000毫秒。正因为有这个发送间隔，才会有上面状态模型中的超时机制。


# 双星模式反应器模式


[fsm]:https://en.wikipedia.org/wiki/Finite-state_machine
[bstarsrv.c]:https://github.com/imatix/zguide/blob/master/examples/C/bstarsrv.c
